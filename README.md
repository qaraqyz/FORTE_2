## Задача: 
Нужно разработать RAG ассистента для аналитики с чат-интерфейсом, имеющего доступ к данным о продажах (например, продажи медикаментов в аптечной сети). Данные допускается сгенерировать самостоятельно; код генерации необходимо включить в поставку. Ассистент должен уметь сравнивать показатели, строить графики и показывать разрезы по медикаментам, регионам, периодам и др. Требуется предоставить готовый к сабмиту результат, по возможности рабочий прототип и ссылку на гит репозиторий с описанием архитектуры 

## Ключевые требования

- **Функционал:**  
  - понимание пользовательских вопросов на естественном языке  
  - семантический поиск по базе знаний с pgvector
  - генерация SQL и выполнение только безопасных `SELECT`  
  - визуализация результатов (Plotly) 
- **Нефункциональные:**  
  - воспроизводимый запуск через `docker-compose` 
  - конфигурация через файл `.env`
  - детальная трассировка действий агентов в логах 
  - возможность локального запуска без внешних сетевых запросов, кроме OpenAI API

## Архитектура

```
┌─────────────────────────────┐
│        Streamlit UI         │
└──────────────┬──────────────┘
               │
┌──────────────▼──────────────┐
│ Conversational Agent        │
│ (основной мозг)             │
│ - парсит запрос             │
│ - дергает инструменты       │
│ - формирует ответ           │
└────┬──────────┬─────────────┘
     │          │
┌────▼───┐  ┌──▼─────┐   ┌──────────────┐
│ RAG    │  │ SQL    │   │ Visualizer   │
│ Agent  │  │ Agent  │   │ Tool         │
└────┬───┘  └──┬─────┘   └─────┬────────┘
     │         │              │
     │   PostgreSQL + pgvector
     │        (177 векторов)
     │
  PostgreSQL (реляционные данные)
```

## Компоненты

- `ui/streamlit_app.py` — чат-интерфейс и обработка событий 
- `agents/` — код и промпты для главного, RAG и SQL агентов 
- `tools/sql_executor.py` — выполнение SQL против PostgreSQL 
- `tools/visualizer.py` — сборка графиков (Plotly)
- `data/` — скрипты подготовки и загрузки данных
- `database/` — инициализация схемы и прогрев векторного хранилища
- `utils/` — обертки для работы с БД и логированием

## Требования к окружению
- Python ≥ 3.10.  
- Docker Desktop (Compose 2.x)  
- PostgreSQL 14+ с расширением `pgvector` 
- OpenAI API ключ с доступом к `gpt-4o`  
- Настольная среда разработки с поддержкой Streamlit (для локального демо)

## Переменные окружения

Файл `.env` github не пропускал(из за того что там есть api от openai) из за этого можете вставить свой:

```
DB_HOST=localhost
DB_PORT=5433
DB_NAME=pharmacy_analytics
DB_USER=postgres
DB_PASSWORD=postgres

OPENAI_API_KEY=your_actual_api_key_here(доступ будет до субботы)

CONVERSATIONAL_MODEL=gpt-4o
SQL_MODEL=gpt-4o
SQL_TEMPERATURE=0.0
CONVERSATIONAL_TEMPERATURE=0.5
```

## Развертывание

1. `pip install -r requirements.txt`  базовые зависимости (Streamlit, langchain, plotly, psycopg)
2. `docker-compose up -d`  поднимает PostgreSQL с `pgvector`
3. `python data/load_data.py <путь к CSV>`  загружает исходные продажи
4. `python database/seed_vector_store.py` заполняет векторное хранилище (если нужно обновить)  
5. `streamlit run ui/streamlit_app.py` — запускает интерфейс

## Работа с данными

- `data/load_data.py` очищает таблицу `sales`, потом грузит файлы батчами через `COPY` 
- Скрипт печатает статистику по диапазону дат, количеству регионов, аптек и продуктов

Схема `sales`:

```sql
CREATE TABLE sales (
    id SERIAL PRIMARY KEY,
    date DATE NOT NULL,
    region VARCHAR(100) NOT NULL,
    pharmacy VARCHAR(100) NOT NULL,
    category VARCHAR(100) NOT NULL,
    product VARCHAR(255) NOT NULL,
    units_sold INTEGER NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    cost_price DECIMAL(10, 2) NOT NULL,
    revenue DECIMAL(10, 2) NOT NULL,
    profit DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Поведение агентов

1. **Conversational Agent** анализирует текст запроса, выбирает инструмент (RAG, SQL, визуализация) и агрегирует результат.  
2. **RAG Agent** выполняет семантический поиск по документам (177 векторных записей)
3. **SQL Agent** через промпт `agents/prompts/sql_picker_ai.txt` строит SQL, который исполняется в `tools/sql_executor.py` Допускаются только `SELECT`
4. **Visualizer** собирает результат в графики (Plotly) и возвращает HTML для Streamlit

## Тестирование
Чтобы протестировать ИИ можете внести эти запросы:
  1. Запрос «Покажи топ-10 препаратов по продажам» возвращает таблицу  
  2. Запрос «Построй график продаж витаминов по месяцам» отрисовывает график  
  3. Запрос «Сравни выручку по регионам за 2024 год» выдает корректные цифры 
  4. Дай информация по аптекам в Шымкенте
